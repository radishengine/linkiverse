<!DOCTYPE html>
<html>
<head>
  <title>ArcLight</title>
  <script type='text/javascript'>
    
function IAItem(identifier) {
  this.identifier = identifier;
}

IAItem.prototype = {
  getFileRequestUrl: function(filename) {
    return '//cors.archive.org/cors/' + this.identifier + '/' + filename;
  },
  pullXml: function(filename) {
    return fetch(this.getFileRequestUrl(filename), {cache:'force-cache'})
    .then(function(request) {
      return request.text();
    })
    .then(function(text) {
      return new DOMParser().parseFromString(text, 'application/xml');
    });
  },
  pullBlob: function(filename) {
    return fetch(this.getFileRequestUrl(filename), {cache:'force-cache'})
    .then(function(request) {
      return request.blob();
    });
  },
  getMetadata: function() {
    return this.pullXml(this.identifier + '_meta.xml')
    .then(function(xml) {
      var obj = {};
      for (var node = xml.documentElement.firstChild; node != null; node = node.nextSibling) {
        if (node.nodeType !== 1) continue;
        obj[node.nodeName] = node.textContent;
      }
      return Object.freeze(obj);
    });
  },
  getFiles: function() {
    return this.pullXml(this.identifier + '_files.xml')
    .then(function(xml) {
      var arr = {};
      for (var node = xml.documentElement.firstChild; node != null; node = node.nextSibling) {
        if (node.nodeName !== 'file') continue;
        var obj = {source: node.getAttribute('source')};
        for (var node2 = node.firstChild; node2 != null; node2 = node2.nextSibling) {
          if (node2.nodeType !== 1) continue;
          obj[node2.nodeName] = node2.textContent;
        }
        arr[node.getAttribute('name')] = obj;
      }
      return arr;
    });
  },
  getChildItems: function() {
    var self = this;
    return new Promise(function(resolve, reject) {
      var script = document.createElement('SCRIPT');
      var callbackNumber = 0;
      var callbackName;
      while (typeof window[callbackName = 'cb'+callbackNumber] !== 'undefined') {
        callbackNumber++;
      }
      window[callbackName] = function(data) {
        resolve(Object.freeze(data.response.docs.map(function(doc) {
          return new IAItem(doc.identifier);
        })));
        delete window[callbackName];
        document.head.removeChild(script);
      };
      script.type = 'text/javascript';
      script.src = '//archive.org/advancedsearch.php'
        + '?q=collection:' + self.identifier
        + '&fl[]=identifier'
        + '&sort[]=publicdate+asc'
        + '&rows=50'
        + '&page=1'
        + '&output=json'
        + '&callback=' + callbackName
        + '&save=yes';
      document.head.appendChild(script);
    });
  },
};

var root = new IAItem('adventuregamestudio');
    
function clickItem() {
  var item = this.item;
  item.getFiles().then(function(files) {
    var filenames = Object.keys(files);
    var zips = [];
    for (var i = 0; i < filenames.length; i++) {
      if (/\.zip$/i.test(filenames[i])) {
        zips.push(filenames[i]);
      }
    }
    if (zips.length === 0) {
      return Promise.reject('no zip found');
    }
    if (zips.length > 1) {
      return Promise.reject('more than one zip found');
    }
    return item.pullBlob(zips[0]);
  })
  .then(function(blob) {
    console.log(blob.size);
  });
}
    
root.getChildItems()
.then(function(childItems) {
  var itemList = document.getElementById('item-list-container');
  var baseIndex = 0;
  itemList.style.height = (childItems.length * 4) + 'ex';
  for (var i = 0; i < childItems.length; i++) {
    var item = childItems[i];
    var itemEl = document.createElement('DIV');
    itemEl.item = item;
    itemEl.addEventListener('click', clickItem);
    itemEl.className = 'item';
    itemEl.innerText = item.identifier;
    itemEl.style.top = ((baseIndex + i) * 4) + 'ex'; 
    itemList.appendChild(itemEl);
  }
});
  
  </script>
  <style type='text/css'>
    html, body {
      height: 100%;
      padding: 0;
      margin: 0;
      font-family: sans-serif;
    }
    #item-list {
      overflow-y: auto;
      height: 100%;
      width: 15em;
      position: fixed;
      font-size: 10pt;
    }
    #item-list-container {
      background: black;
      position: relative;
      overflow: hidden;
    }
    .item {
      box-shadow: rgba(0,0,0,0.5) 0 0 3px;
      height: 4ex;
      line-height: 4ex;
      background: white;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
      position: absolute;
      width: 100%;
      padding-left: 0.5em;
      cursor: pointer;
    }
    .item:hover {
      background: #eee;
    }
  </style>
</head>
<body>
  <div id='item-list'>
    <div id='item-list-container'>
    </div>
  </div>
</body>
</html>
