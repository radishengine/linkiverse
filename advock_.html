<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <title>Advock Test</title>
  </head>
  <body>
    <script type='text/x-advock' id='the-script'>
    
[become:pirate/] [free:governor-marley/] [defeat:ghost-pirate-lechuck/] [roll:credits/]

[become:pirate] [master:sword/] [/become:pirate]
[become:pirate] [master:treasure/] [/become:pirate]
[become:pirate] [master:theft/] [/become:pirate]

[master:sword] [locate:sword] [obtain:sword/] [learn-theory:sword/] [learn-practical:sword/] [defeat:sword-master/] [/master:sword]
[master:sword] [locate:sword-master/] [defeat:sword-master/] [/master:sword]
[master:treasure] [locate:x-marks-the-spot/] [excavate:x-marks-the-spot/] [/master:treasure]
[master:treasure] [locate:shovel/] [obtain:shovel/] [excavate:x-marks-the-spot/] [/master:treasure]
[master:theft] [locate:mansion/] [infiltrate:mansion/] [unlock:fabulous-idol/] [escape:attempted-drowning/] [/master:theft]

[locate:sword-master] [identify-associate:shopkeep/] [request-meeting:shopkeep/] [follow:shopkeep/] [/locate:sword-master]

[locate:x-marks-the-spot] [locate:treasure-map/] [obtain:treasure-map/] [decode:treasure-map/] [/locate:x-marks-the-spot]

[escape:attempted-drowning] [pick-up:fabulous-idol/] [/escape:attempted-drowning]

[obtain:funds/] [obtain:sword/]
[obtain:funds/] [obtain:treasure-map/]
[obtain:funds/] [obtain:shovel/]
    
    </script>
    <script type='text/javascript'>
      var map = {'':{}};
      var text = document.getElementById('the-script').text;
      text.split(/\n/g).map(function(line) {
        return line.replace(/#.*/, '').trim();
      }).filter(function(line) {
        return !!line;
      }).map(function(line) {
        return line.split(/\s+/g).map(function(part) {
          var match = part.match(/^\[(\/)?([^\/\]]+)(\/)?\]$/);
          if (!match || (match[1] && match[3])) {
            throw new Error('unexpected content: ' + part);
          }
          var leftClose = !!match[1];
          var rightClose = leftClose || !match[3];
          return {leftClose:leftClose, rightClose:rightClose, name:match[2]};
        });
      }).forEach(function(line) {
        if (!(line[0].name in map)) {
          map[''][line[0].name] = true;
          map[line[0].name] = {};
          map[line[0].name]['/'+line[0].name] = true;
          map['/'+line[0].name] = {};
        }
        for (var i = 1; i < line.length; i++) {
          if (!(line[i].name in map)) {
            map[line[i].name] = {};
            map[line[i].name]['/'+line[i].name] = true;
            map['/'+line[i].name] = {};
          }
          var prev = (line[i-1].leftClose ? '/' : '') + line[i-1].name;
          var name = (line[i].rightClose ? '/' : '') + line[i].name;
          map[prev][name] = true;
        }
      });
      console.log(map);
    </script>
  </body>
</html>
