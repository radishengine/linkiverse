<!DOCTYPE html>
<html>
<head>
  <title>HyperCard Tool</title>
  <link rel="stylesheet" media="screen" href="https://fontlibrary.org/face/chicagoflf" type="text/css">
  <style>
    pre {
      white-space: pre-wrap;
      font-family: 'ChicagoFLFRegular', sans-serif;
      font-size: 9pt;
    }
    body:not(.show-code) .code { display: none; }
    body {
      font-family: 'ChicagoFLFRegular', sans-serif;
    }
    .loading {
      background: repeating-linear-gradient(
        -45deg,
        rgba(255, 255, 0, 0.1),
        rgba(255, 255, 0, 0.1) 20px,
        rgba(  0,   0, 0, 0.1) 20px,
        rgba(  0,   0, 0, 0.1) 40px);
      background-size: 56px 56px;
      background-attachment: fixed;
      min-height: 1ex;
    }
    .loading .loading {
      box-shadow: none;
      background-image: none;
    }
    .error {
      background: #f88;
    }
    .gallery {
      display: flex;
      flex-flow: row wrap;
      justify-content: space-around;
      align-items: center;
      align-content: space-around;
    }
    .gallery > * {
      margin: 2px;
    }
  </style>
</head>
<body>
  <div id='templating' style='display:none'>
    <style>
      .spinner {
        text-align: center;
        font-size: 10px;
        background: black;
        opacity: 0.5;
        border-radius: 5px;
        flex-grow: 1;
        order: 1000000;
        align-self: stretch;
      }
      .spinner > div {
        background-color: #aaa;
        height: 30px;
        width: 6px;
        display: inline-block;
        -webkit-animation: sk-stretchdelay 1.2s infinite ease-in-out;
        animation: sk-stretchdelay 1.2s infinite ease-in-out;
        margin: 3px 0;
      }
      .spinner > .rect2 {
        -webkit-animation-delay: -1.1s;
        animation-delay: -1.1s;
      }
      .spinner > .rect3 {
        -webkit-animation-delay: -1.0s;
        animation-delay: -1.0s;
      }
      .spinner > .rect4 {
        -webkit-animation-delay: -0.9s;
        animation-delay: -0.9s;
      }
      .spinner > .rect5 {
        -webkit-animation-delay: -0.8s;
        animation-delay: -0.8s;
      }
      @-webkit-keyframes sk-stretchdelay {
        0%, 40%, 100% { -webkit-transform: rotate(30deg) scaleY(0.4) }  
        20% { -webkit-transform: scaleY(1.0) }
      }
      @keyframes sk-stretchdelay {
        0%, 40%, 100% { 
          transform: rotate(30deg) scaleY(0.4);
          -webkit-transform: rotate(30deg) scaleY(0.4);
        }
        20% { 
          transform: scaleY(1.0);
          -webkit-transform: scaleY(1.0);
        }
      }
    </style>
    <div class="spinner">
      <div class="rect1"></div>
      <div class="rect2"></div>
      <div class="rect3"></div>
      <div class="rect4"></div>
      <div class="rect5"></div>
    </div>
  </div>
  <label style='display:none'>
    <input type='checkbox' onchange='document.body.className = this.checked ? "show-code" : ""'>
    Show code?
  </label>
  <div id='content'></div>
  <script>
    
function download(thing) {
  if (!(thing instanceof Blob)) {
    thing = new Blob([thing]);
  }
  var link = document.createElement('A');
  link.href = URL.createObjectURL(thing);
  link.setAttribute('download', 'file.dat');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
    
function makeSpinner() {
  return document.querySelector('#templating > .spinner').cloneNode(true);
}
    
var hcWorker = new Worker('hcworker.js');

function update() {

  'use strict';
  
  var name = location.hash.match(/^#\/?([a-zA-Z0-9_\-\.]+)\/?$/);
  name = name && name[1];
  if (!name) {
    document.getElementById('content').innerHTML = 'Please set URL #hash to a hypercard item ID';
    return;
  }
  
  document.getElementById('content').innerHTML = '';
  var fileContainer = document.getElementById('content');
  var fileSpinner = makeSpinner();
  fileContainer.appendChild(fileSpinner);

  hcWorker.onmessage = function(e) {
    var message = e.data;
    if (message.item !== name) return;
    switch (message.headline) {
      case 'open':
        if (message.scope === 'file' && !message.isInvisible) {
          var container = document.createElement('DIV');
          var header = document.createElement('H1');
          header.innerText = [
            '[' + message.modifiedAt.toISOString().replace(/\..*/, '') + ']',
            '[' + message.type + ']',
            message.path,
          ].join(' ');
          container.appendChild(header);
          container.id = encodeURIComponent(message.path);
          var gallery = document.createElement('DIV');
          gallery.className = 'gallery';
          gallery.appendChild(makeSpinner());
          container.appendChild(gallery);
          fileContainer.insertBefore(container, fileSpinner);
        }
        break;
      case 'close':
        if (message.scope === 'disk') {
          fileContainer.removeChild(fileSpinner);
          fileSpinner = null;
        }
        if (message.scope === 'file') {
          var closeFileContainer = document.getElementById(encodeURIComponent(message.path));
          if (closeFileContainer) {
            var spinner = closeFileContainer.querySelector('.gallery > .spinner');
            if (spinner) {
              spinner.parentNode.removeChild(spinner);
            }
          }
        }
        break;
      case 'image':
        var container = document.getElementById(encodeURIComponent(message.path));
        if (container) {
          var gallery = container.querySelector('.gallery');
          var img = document.createElement('IMG');
          if (message.width && message.height) {
            img.width = message.width;
            img.height = message.height;
          }
          img.style.order = Math.ceil(Math.log2(Math.max(32, message.height)));
          img.src = URL.createObjectURL(message.file);
          gallery.appendChild(img);
        }
        break;
      case 'text':
        var container = document.getElementById(encodeURIComponent(message.path));
        if (container) {
          var text = document.createElement('PRE');
          text.innerText = message.text;
          container.appendChild(text);
        }
        break;
      default:
        console.log(message);
        break;
    }
  };
  
  hcWorker.postMessage({
    headline: 'load',
    item: name,
  });
  
}
    
window.onhashchange = function() {
  update();
};
    
update();

  </script>
</body>
</html>
