<html>
<head>
  <script type='text/javascript'>
    
    var openedDB = new Promise(function(resolve, reject) {
      var opening = indexedDB.open('spec', 1);
      opening.onupgradeneeded = function(e) {
        var db = e.target.result;
        var nodeStore = db.createObjectStore('nodes', {autoIncrement:true});
        nodeStore.createIndex('byId', 'id', {unique:false});
        nodeStore.createIndex('byClass', 'classList', {multiEntry:true});
      };
      opening.onerror = function(e) {
        reject();
      };
      opening.onsuccess = function(e) {
        resolve(e.target.result);
      };
    });
    
    function initialize(specRoot) {
      var specElements = specRoot.dataset.specElements; // TODO: allow editing?
      
      function putElement(transaction, el, isNew, idCallback) {
        var record = {
          nodeName: el.nodeName,
          classList: [].slice.apply(el.classList)
        };
        for (var i = 0; i < el.attributes.length; i++) {
          var attr = el.attributes[i];
          if (!attr.specified || /^(?:class|contenteditable|data-id)$/i.test(attr.name)) continue;
          record[attr.name] = attr.value;
        }
        function finalStore() {
          if (isNew || isNaN(el.dataset.id)) {
            transaction.objectStore('nodes').add(record).onsuccess = function(e) {
              el.dataset.id = e.target.result;
              if (idCallback) idCallback(e.target.result);
            };
          }
          else {
            transaction.objectStore('nodes').put(record, +el.dataset.id);
            if (idCallback) idCallback(+el.dataset.id);
          }
        }
        var nested = el.querySelectorAll(specElements);
        if (nested.length === 0) {
          record.innerHTML = el.innerHTML;
          finalStore();
          return;
        }
        var ids = new Array(nested.length);
        var count = 0;
        function gotId(i, id) {
          ids[i] = id;
          if (++count < ids.length) return;
          var dup = el.cloneNode(true);
          var nested = [].slice.apply(nested);
          for (var j = 0; j < ids.length; j++) {
            var replace = dup.querySelector('#'+ids[j]);
            var placeholder = document.createElement('DIV');
            placeholder.dataset.placeholder = ids[i];
            replace.parentNode.insertBefore(placeholder, replace);
            replace.parentNode.removeChild(replace);
          }
          record.innerHTML = dup.innerHTML;
          finalStore();
        }
        for (var i = 0; i < nested.length; i++) {
          // ignore if >1 level deep
          var ancestor = nested[i].parentNode;
          while (ancestor !== el && !ancestor.matches(specElements)) ancestor = ancestor.parentNode;
          if (ancestor !== el) continue;
          putElement(transaction, nested[i], isNew, gotId.bind(null, i));
        }
      }
      
      return openedDB.then(function(db) {
        return new Promise(function(resolve, reject) {
        
          var temp = document.createElement('DIV');

          db.transaction(['nodes'], 'readonly').objectStore('nodes').openCursor().onsuccess = function(e) {
            var cursor = e.target.result;
            if (!cursor) {
              resolve(temp);
              return;
            }
            var node = document.createElement(cursor.value.nodeName);
            node.className = (cursor.value.classList || []).join(' ');
            node.innerHTML = cursor.value.innerHTML || '';
            Object.keys(cursor.value).forEach(function(k) {
              if (/^(?:nodeName|classList|innerHTML)$/i.test(k)) return;
              node.setAttribute(k, cursor.value[k]);
            });
            node.dataset.id = cursor.key;
            temp.appendChild(node);
          };
            
        })
        .then(function(temp) {
          var root = temp.querySelector('#' + specRoot.id);
          if (!root) {
            return null;
          }
          function doPlaceholders(el) {
            var placeholders = temp.querySelectorAll('*[data-placeholder]');
            if (placeholders.length === 0) return;
            [].slice.apply(placeholders).forEach(function(placeholder) {
              var id, replacement;
              if (!/\d+/.test(id = placeholder.dataset.placeholder)) {
                replacement = document.createComment('INVALID:' + id);
              }
              else if (!(replacement = temp.querySelect('*[data-placeholder='+id+']'))) {
                replacement = document.createComment('MISSING:' + id);
              }
              else if (replacement.parentNode !== temp) {
                replacement = document.createComment('DUPLICATE:' + id);
              }
              else {
                temp.removeChild(replacement);
              }
              placeholder.parentNode.insertBefore(replacement, placeholder);
              placeholder.parentNode.removeChild(placeholder);
              if (replacement.nodeType === Node.ELEMENT_NODE) {
                doPlaceholders(replacement);
              }
            });
          }
          doPlaceholders(root);
          return root;
        })
        .then(function(root) {
          specRoot.innerHTML = '';
          if (!root) return specRoot;
          while (root.childNodes.length > 0) {
            specRoot.appendChild(root.removeChild(root.childNodes[0]));
          }
          specRoot.dataset.id = root.dataset.id;
        })
        .then(function(specRoot) {

          new MutationObserver(function(mutants) {
            var nodeStore = db.transaction(['nodes'], 'readwrite').objectStore('nodes');
            var to_update = [];
            for (var i = 0; i < mutants.length; i++) {
              var mutant = mutants[i];
              var container;
              switch (mutant.type) {
                case 'childNodes':
                  for (var j = 0; j < mutant.removedNodes.length; j++) {
                    var removed = mutant.removedNodes[j];
                    if (removed.nodeType !== Node.ELEMENT_NODE) continue;
                    if (!isNaN(removed.dataset.id)) {
                      nodeStore.delete(+removed.dataset.id);
                    }
                    var nested = removed.querySelectorAll('[data-id]');
                    for (var i = 0; i < nested.length; i++) {
                      nodeStore.delete(+nested[i].dataset.id);
                    }
                  }
                  for (var j = 0; j < mutant.addedNodes.length; j++) {
                    if (mutant.addedNodes[j].nodeType !== Node.ELEMENT_NODE) continue;
                    delete mutant.addedNodes[j].dataset.id;
                    var subIDs = mutant.addedNodes[j].querySelectorAll('*[data-id]');
                    for (var k = 0; k < subIDs.length; k++) {
                      delete subIDs[k].dataset.id;
                    }
                  }
                  container = mutant.target;
                  break;
                case 'attributes':
                  if (mutant.attributeName === 'data-id') continue;
                  container = mutant.target;
                  break;
                case 'characterData':
                  container = mutant.target.parentNode;
                  break;
              }
              while (isNaN(container.dataset.id)) container = container.parentNode;
              if (to_update.indexOf(container) === -1) to_update.push(container);
            }
            
          })
          .observe(specRoot, {
            childList: true,
            attributes: true,
            subtree: true,
            characterData: true,
            attributeOldValue: true,
          });

        });
      });
    }
    
  </script>
</head>
<body>
  <div id='spec-root' data-spec-elements='section, article'>
  </div>
  <script>initialize(document.getElementById('spec-root'));</script>
</body>
</html>
