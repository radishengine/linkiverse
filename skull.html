<html>
<head>
  <script type='text/javascript'>
    
    var openedDB = new Promise(function(resolve, reject) {
      var opening = indexedDB.open('spec', 2);
      opening.onupgradeneeded = function(e) {
        var db = e.target.result;
        var items = db.createObjectStore('item', {keyPath:'id'});
        items.createIndex('class', 'classList', {multiEntry:true});
        var bulletins = db.createObjectStore('bulletin', {keyPath:'id'});
        bulletins.createIndex('item', 'item');
        bulletins.createIndex('class', 'classList', {multiEntry:true});
      };
      opening.onerror = function(e) {
        reject();
      };
      opening.onsuccess = function(e) {
        resolve(e.target.result);
      };
    });
    
    function makeItemElement(itemDef) {
      var el = document.createElement('DIV');
      el.classList.add('item');
      Object.keys(itemDef).forEach(function(k) {
        switch (k) {
          case 'classList':
            itemDef.classList.forEach(function(c) {
              el.classList.add(c);
            });
            return;
        }
        el.setAttribute(k, itemDef[k]);
      });
      return el;
    }
    
    function getItemDef(el) {
      if (!el.id) {
        var idBase = 'item', inc = 1;
        while (document.querySelector('#' + idBase + inc)) inc++;
        el.setAttribute('id', idBase + inc);
      }
      var obj = {};
      obj.classList = [].filter.apply(el.classList, function(className) {
        return !/^(?:item)$/i.test(className);
      });
      for (var i = 0; i < el.attributes.length; i++) {
        var attr = el.attributes[i];
        if (!attr.specified || /^(?:class|contenteditable)$/i.test(attr.name)) continue;
        obj[attr.name] = attr.value;
      }
      return obj;
    }
    
    function makeBulletinElement(bulletinDef) {
      var el = document.createElement('DIV');
      el.classList.add('bulletin');
      el.innerHTML = bulletinDef.html || '';
      Object.keys(bulletinDef).forEach(function(k) {
        switch (k) {
          case 'classList':
            itemDef.classList.forEach(el.classList.add.bind(el.classList));
            return;
          case 'html':
            return;
        }
        el.setAttribute(k, bulletinDef[k]);
      });
      return el;
    }
    
    function getBulletinDef(el) {
      var obj = {html:el.innerHTML};
      for (var itemRoot = el.parentNode; itemRoot; itemRoot = itemRoot.parentNode) {
        if (itemRoot.classList.contains('item')) {
          obj.item = itemRoot.id;
          if (!el.id) {
            var idBase = itemRoot.id + '$', inc = 1;
            while (document.querySelector('#' + idBase + inc)) inc++;
            el.setAttribute('id', idBase + inc);
          }
          break;
        }
      }
      obj.classList = [].filter.apply(el.classList, function(className) {
        return !/^(?:bulletin)$/i.test(className);
      });
      for (var i = 0; i < el.attributes.length; i++) {
        var attr = el.attributes[i];
        if (!attr.specified || /^(?:class|contenteditable)$/.test(attr.name)) continue;
        obj[attr.name] = attr.value;
      }
      return obj;
    };
    
    function initialize(specRoot) {
      specRoot.style.display = 'none';
      return openedDB.then(function(db) {
        function removeItem(items, bulletinsByItem, id) {
          items.delete(id);
          bulletinsByItem.openCursor(IDBKeyRange.only(id)).onsuccess = function(e) {
            var cursor = e.target.result;
            if (!cursor) return;
            items.delete(cursor.value.id);
            cursor.continue();
          };
        }
        function addItem(items, bulletins, el) {
          items.put(getBulletinDef(el));
        }
        function onmutant(mutant) {
          if (mutant.target === specRoot) {
            if (mutant.type === 'childList') {
              var transaction = db.transaction(['item', 'bulletin'], 'readwrite');
              var items = transaction.objectStore('item');
              var bulletins = transaction.objectStore('bulletin');
              bulletins.byItem = bulletins.index('item');
              for (var i = 0; i < mutant.removedNodes.length; i++) {
                var node = mutant.removedNodes[i];
                if (node.classList && node.classList.contains('item') && node.id) {
                  removeItem(items, bulletins.byItem, node.id);
                }
              }
              for (var i = 0; i < mutant.addedNodes.length; i++) {
                var node = mutant.addedNodes[i];
                if (node.classList && node.classList.contains('item')) {
                  addItem(items, bulletins, node);
                }
              }
            }
            return;
          }
          if (mutant.target.parentNode === specRoot) {
            if (mutant.target.classList.contains('item') && mutant.target.id) {
              if (mutant.type === 'attributes') {
                db.transaction(['item'], 'readwrite').objectStore('item').put(getItemDef(mutant.target));
              }
              else if (mutant.type === 'childList') {
                var updating = db.transaction(['bulletin'], 'readwrite');
                var bulletins = updating.objectStore('bulletin');
                for (var i = 0; i < mutant.removedNodes.length; i++) {
                  var node = mutant.removedNodes[i];
                  if (node.classList && node.classList.contains('bulletin') && node.id) {
                    bulletins.delete(node.id);
                  }
                }
                for (var i = 0; i < mutant.addedNodes.length; i++) {
                  var node = mutant.addedNodes[i];
                  if (node.classList && node.classList.contains('bulletin')) {
                    bulletins.put(getBulletinDef(node));
                  }
                }
              }
            }
            return;
          }
          var bulletinRoot;
          for (bulletinRoot = mutant.target; ; bulletinRoot = bulletinRoot.parentNode) {
            if (!bulletinRoot || bulletinRoot === specRoot) return;
            if (bulletinRoot.classList.contains('bulletin')) break;
          }
          var itemRoot;
          for (itemRoot = bulletinRoot.parentNode; ; itemRoot = itemRoot.parentNode) {
            if (!itemRoot || itemRoot === specRoot) return;
            if (itemRoot.classList.contains('item')) break;
          }
          if (itemRoot.parentNode !== specRoot) return;
        }
        return new Promise(function(resolve, reject) {
          var initialRead = db.transaction(['item', 'bulletin'], 'readonly');
          initialRead.onerror = initialRead.onabort = function() {
            reject();
          };
          initialRead.oncomplete = function() {
            resolve();
          };
          var bulletinsByItem = initialRead.objectStore('bulletin').index('item');
          initialRead.objectStore('item').openCursor().onsuccess = function(e) {
            var cursor = e.target.result;
            if (!cursor) return;
            var itemDef = cursor.value;
            var itemEl = makeItemElement(itemDef);
            specRoot.appendChild(itemEl);
            if (itemDef.id) {
              bulletinsByItem.openCursor(IDBKeyRange.only(itemDef.id)).onsuccess = function(e) {
                var cursor = e.target.result;
                if (!cursor) return;
                var bulletinDef = cursor.value;
                var bulletinEl = makeBulletinElement(bulletinDef);
                itemEl.appendChild(bulletinEl);
              };
            }
            cursor.continue();
          };
        })
        .then(function() {
          var peeper = new MutationObserver(function(mutations) {
            mutations.forEach(onmutant);
          });
          peeper.observe(specRoot, {
            childList: true,
            attributes: true,
            subtree: true,
            characterData: true,
          });
          specRoot.style.display = 'block';
        });
      },
      function() {
        console.error('Failed to open indexedDB');
      });
    }
        
  </script>
</head>
<body>
  <div id='spec'>
  </div>
  <script>initialize(document.getElementById('spec'));</script>
</body>
</html>
